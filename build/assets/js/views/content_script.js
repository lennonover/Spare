$(function(){var e,n,i,a,t,o,s,c,r=!1,l={toggle:!0},d={successTpl:["<div class=spareWindow>","<div class=spare-content>{{content}}</div>","<div class=spare-pronunciation><span class=pronunciation-uk >英<i><audio src={{uk_audio}}></audio></i>[{{pronunciationUK}}]</span><span class=pronunciation-us >美<i><audio src={{us_audio}}></audio></i>[{{pronunciation}}]</span></div>","<div>{{#definition}}</div>","</div>"].join(""),errorTpl:["<div class=spareWindow>","<div class=spare-content>{{msg}}</div>","</div>"].join("")},p={init:function(){var e=this;e.removeDom(),e.addEventOn(),e.resolution(),e.addEventOnPage(),t=function(){e.translate()},window.document.body.addEventListener("mouseup",t,!1),window.document.body.addEventListener("keyup",e.toggleOC.bind(e),!1),$(window).resize(function(){e.resolution()})},removeDom:function(){for(var e=["navigation-container","content__labels--not-immersive","content__labels--not-immersive","element-rich-link","content__meta-containe","tone-news--item","js-football-meta","element-rich-link","js-components-container","contributions__epic","submeta","site-message--membership-prominent.purple","content-footer","l-footer"],n=e.length-1;n>=0;n--)$("."+e[n]).remove();setInterval(function(){$(".selection-sharing.selection-sharing--active").remove(),$(".site-message--membership-prominent").remove(),$(".element").remove()},1e3)},translate:function(t){var t=t||window.event,o=document.getSelection();if(o.anchorNode&&3==o.anchorNode.nodeType){var s=o.toString();if(""==s)return;s=s.replace("-\n",""),s=s.replace("\n"," "),e=t.clientX,n=t.clientY,i=t.pageX,a=t.pageY,this.showTran(s)}},showTran:function(e){var n=this,i="https://api.shanbay.com/bdc/search/?word="+e;$.ajax({type:"GET",url:i}).done(function(e){$(".spareWindow").remove(),0===e.status_code?n.showDialog(e.data,d.successTpl):n.showDialog(e,d.errorTpl)}).fail(function(){console.log("请求失败")}).always(function(){})},showDialog:function(t,o){if(void 0!==t.definition){var s=t.definition,c=/\n|\r\n|\r/g;s=s.replace(c,"<br>"),t.definition=s,t.pronunciationUK=t.pronunciations.uk}var r=Wltpl(o,t);$("body").append(r);var l="url("+chrome.extension.getURL("imgs/pron.png")+")";$(".spare-pronunciation i").css("background-image",l);var d=$(".spareWindow").height(),p=$(".spareWindow").width();n<d+10?e<p/2?$(".spareWindow").animate({left:5,top:a+20,opacity:"show"},10):$(window).width()-e<p?$(".spareWindow").animate({left:$(window).width()-p-30,top:a+20,opacity:"show"},10):$(".spareWindow").animate({left:i+8,top:a+8,opacity:"show"},10):e<p/2?$(".spareWindow").animate({left:5,top:a-d-30,opacity:"show"},10):$(window).width()-e<p?$(".spareWindow").animate({left:$(window).width()-p-30,top:a-d-30,opacity:"show"},10):$(".spareWindow").animate({left:i,top:a-d-30,opacity:"show"},10)},addEventOn:function(){$(document).on("click","body",function(e){r?r=!1:$(".spareWindow").remove()}),$(document).on("click",".spareWindow",function(e){r=!0}),$(document).on("mouseenter",".spare-pronunciation i",function(e){var n=$(this),i=n.find("audio");i.get(0).play()})},toggleOC:function(e){81==e.which&&e.altKey&&e.ctrlKey&&(l.toggle?(window.document.body.removeEventListener("mouseup",t,!1),l.toggle=!1,console.log("已关闭取词")):(window.document.body.addEventListener("mouseup",t,!1),l.toggle=!0,console.log("已打开取词")))},inittoggleOC:function(e){chrome.storage.sync.get(null,function(n){$.extend(l,n),chrome.storage.sync.set(l,function(e){console.log("初始化完成")}),e&&e()})},eventOptions:function(e){for(var n in e){var i=e[n];l[n]=i.newValue}},pagingFun:function(){c=$(".content__article-body").children().size(),s=Math.ceil(c/o);for(var e=['<div class="space-paging"><a class="previous-link" href="javascript:;">Prev</a>'],n=0;s>n;)e.push('<a class="page-link" href="javascript:;" longdesc="'+n+'">'+(n+1)+"</a>"),n++;e.push('<a class="next-link" href="javascript:;">Next</a></div>'),$(".space-paging")&&$(".space-paging").remove(),$(".after-article").before(e.join("")),$(".space-paging .page-link:first").addClass("active-page"),$(".content__article-body").children().css("display","none"),$(".content__article-body").children().slice(0,o).css("display","block"),$(".previous-link").addClass("active-preNext")},goPage:function(e){switch(e){case 0:$(".previous-link").addClass("active-preNext"),$(".next-link").removeClass("active-preNext"),$(".content__head").show(),$(".media-primary").show();break;case s-1:$(".previous-link").removeClass("active-preNext"),$(".next-link").addClass("active-preNext"),$(".content__head").hide(),$(".media-primary").hide();break;default:$(".previous-link").removeClass("active-preNext"),$(".next-link").removeClass("active-preNext"),$(".content__head").hide(),$(".media-primary").hide()}start_from=e*o,end_on=start_from+o,$(".content__article-body").children().css("display","none").slice(start_from,end_on).css("display","block"),$(".page-link[longdesc="+e+"]").addClass("active-page").siblings(".active-page").removeClass("active-page")},addEventOnPage:function(){var e,n=this;$(document).on("click",".space-paging a",function(i){var a=$(this);switch(!0){case"next-link"==a.attr("class"):e=Number($(".active-page").attr("longdesc"))+1,1==$(".active-page").next(".page-link").length&&n.goPage(e);break;case"previous-link"==a.attr("class"):e=Number($(".active-page").attr("longdesc"))-1,1==$(".active-page").prev(".page-link").length&&n.goPage(e);break;case"page-link"==a.attr("class"):e=Number(a.attr("longdesc")),n.goPage(e)}})},resolution:function(){var e=this;switch(!0){case screen.height<=480:o=4,e.pagingFun();break;case screen.height<=763:o=6,e.pagingFun();break;case screen.height<=1024:o=8,e.pagingFun();break;default:o=c,e.pagingFun(),$(".space-paging")&&$(".space-paging").remove()}}};p.init()});